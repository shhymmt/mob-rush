# コア戦闘メカニクス計画

**作成日:** 2025-01-17
**ステータス:** 完了

## 概要

### 私が作る必要があるもの

Mob Controlのコア体験を再現するため、以下の機能を実装する：
1. キャノンの方向操作（ドラッグ/スワイプ）
2. 移動する赤い敵ユニット
3. 1対1相殺の戦闘システム

これで私のゲームが「クリックするだけ」から「戦略的な判断が必要なゲーム」に変わる。

---

## 背景と目的

### なぜ私にこれが必要か

Phase 1-5実装後のフィードバック：
> 「はっきりいって、mob-rushのゲームが面白くないです。ただクリックするだけです。」

### 私の問題分析

| 私のMob Rush | 本来のMob Control |
|--------------|-------------------|
| ユニットは真っ直ぐ上に進む | プレイヤーが方向を決める |
| 敵は静止した基地 | 赤い敵が向かってくる |
| HPを削るだけ | 1対1で相殺、数の勝負 |
| 戦略なし | どのゲートを狙うか判断 |

### 私の目標

- プレイヤーに「判断」を求めるゲームにする
- 数で押し合う緊張感を作る
- Mob Controlのコア体験を再現する

---

## 関連する過去の実装

- [02_basic_unit_movement.md](02_basic_unit_movement.md) - Unitスクリプト、オブジェクトプーリング
- [03_multiplier_gates.md](03_multiplier_gates.md) - ゲート通過、ユニット増殖
- [04_enemy_base.md](04_enemy_base.md) - 敵基地、Healthシステム（部分的に再利用）
- [05_basic_game_loop.md](05_basic_game_loop.md) - GameManager、勝敗判定

---

## 私が作るもの

```
┌─────────────────────────────────────────────────────────┐
│                                                         │
│              [敵タワー] HP: ████░░                       │
│                    │                                    │
│                    ▼ (赤ユニットをスポーン)              │
│               ●●● (赤い敵)                              │
│                    │                                    │
│                    ▼                                    │
│   [×2]  ←─────── バトル ───────→  [×3]                 │
│                 (1:1 相殺)                              │
│                    ↑                                    │
│               ○○○ (私の青ユニット)                      │
│                    ↑                                    │
│              [大砲] ←── ドラッグで方向を変更            │
│                                                         │
│   操作: ドラッグした方向に私のユニットが発射される       │
│   戦闘: 青1 + 赤1 = 両方消滅                            │
│   勝利: 私のユニットが敵タワーに到達して破壊            │
│   敗北: 赤ユニットが画面下に到達                        │
│                                                         │
└─────────────────────────────────────────────────────────┘
```

---

## 私の実装アプローチ

### 変更方針

既存のコードを最大限活用し、差分を最小限に抑えたい。

| 機能 | 新規/変更 | 説明 |
|------|----------|------|
| キャノン操作 | 変更 | InputHandlerにドラッグ方向検出を追加 |
| ユニット方向 | 変更 | Unit.csに方向パラメータを追加 |
| 赤ユニット | 新規 | Enemy.cs（Unit.csをベースに作成） |
| 敵スポナー | 新規 | EnemySpawner.cs |
| 戦闘システム | 新規 | Unit/Enemyの衝突で相殺 |
| 敵タワー | 変更 | EnemyBaseをEnemyTowerに変更、スポーン機能追加 |
| 敗北条件 | 変更 | 敵が下に到達で敗北 |

### 影響範囲

**変更するファイル:**
- `Assets/Scripts/Systems/InputHandler.cs` - ドラッグ方向検出
- `Assets/Scripts/Entities/Unit.cs` - 方向パラメータ、敵との衝突
- `Assets/Scripts/Systems/UnitSpawner.cs` - 方向を渡す
- `Assets/Scripts/Entities/EnemyBase.cs` → `EnemyTower.cs` - 敵スポーン機能追加
- `Assets/Scripts/Core/GameManager.cs` - 敗北条件の変更

**新規作成するファイル:**
- `Assets/Scripts/Entities/Enemy.cs` - 赤い敵ユニット
- `Assets/Scripts/Systems/EnemySpawner.cs` - 敵スポーン管理（またはEnemyTowerに統合）

---

## 実装ステップ

### Phase 6A: キャノン操作

1. [x] InputHandlerにドラッグ位置の追跡を追加
2. [x] ドラッグ位置からキャノンへの方向ベクトルを計算
3. [x] UnitSpawnerに方向を渡すインターフェース追加
4. [x] Unit.Initialize()に方向パラメータを追加
5. [x] Unitのvelocityを方向に応じて設定
6. [x] **テスト**: ドラッグした方向にユニットが進む

### Phase 6B: 赤い敵ユニット

1. [x] Enemy.csを作成（Unit.csをベースに、下向きに移動）
2. [x] Enemyタグを作成
3. [x] EnemyTower（旧EnemyBase）に敵スポーン機能を追加
4. [x] 敵スポーン間隔の設定
5. [x] オブジェクトプーリング（Unitと同様）
6. [x] **テスト**: 敵タワーから赤ユニットが出てきて下に進む

### Phase 6C: 1対1相殺の戦闘

1. [x] UnitとEnemyの衝突検出を追加
2. [x] 衝突時に両方を消滅（プールに返す）
3. [x] 視覚的フィードバック（パーティクル等はオプション）
4. [x] **テスト**: 青と赤がぶつかると両方消える

### Phase 6D: 勝敗条件の更新

1. [x] EnemyTowerにHPを設定（Unitが到達するとダメージ）
2. [x] 敗北ライン（画面下）にEnemyが到達したら敗北
3. [x] GameManagerの勝敗判定を更新
4. [x] UIを更新（敗北条件の表示）
5. [x] **テスト**: 勝利・敗北の両方が正しく動作

### Phase 6E: バランス調整

1. [x] 敵スポーン頻度の調整
2. [x] ユニット速度の調整
3. [x] ゲートの配置調整
4. [x] テストプレイで難易度確認

---

## 私の懸念事項

### パフォーマンス

- 青ユニットと赤ユニットの衝突判定が増える
- オブジェクトプーリングを継続使用する
- 必要に応じてPhysics Layerで最適化が必要かも

### 後方互換性

- 既存のシーン構成は大きく変わる
- EnemyBase → EnemyTowerへの移行が必要
- 既存の勝敗UIは再利用可能

### Unity Editor作業

- Enemyプレファブの作成
- EnemyTowerの再設定
- 新しいタグ「Enemy」の作成
- 敗北ライン（透明なトリガー）の配置

---

## テスト計画

| テスト | 手順 | 期待結果 |
|--------|------|----------|
| キャノン操作 | ドラッグしてユニット発射 | ドラッグ方向にユニットが進む |
| 敵スポーン | ゲーム開始 | 敵タワーから赤ユニットが出る |
| 相殺 | 青と赤をぶつける | 両方消える |
| 数で押し勝つ | ゲートで増やして攻撃 | 敵タワーを破壊できる |
| 勝利 | 敵タワーを破壊 | VICTORY表示 |
| 敗北 | 敵に押し負ける | DEFEATED表示 |
| リスタート | 勝敗後にボタン | ゲームリセット |

---

## 完了の定義

- [x] ドラッグでキャノンの向きを変更できる
- [x] 敵タワーから赤ユニットがスポーンする
- [x] 青と赤がぶつかると1対1で相殺する
- [x] 青ユニットが敵タワーに到達するとダメージ
- [x] 赤ユニットが画面下に到達すると敗北
- [x] 勝利・敗北・リスタートが正常に動作
- [x] ゲームに「判断」が必要になり、面白くなる

---

## メモ

- この計画はMob Controlのコア体験を再現することが目的
- 見た目のpolish（パーティクル、サウンド等）は次のフェーズで対応
- 実装中に判明した問題はここに記録する

**2025-01-17 追記**: このフェーズは正常に完了したが、後から私が本当に作りたいゲームとは違うことに気づいた。新しい方向性は [07_lane_runner_mechanics.md](07_lane_runner_mechanics.md) を参照。

---

## 参考

- [Mob Control Strategy Guide - Gamezebo](https://www.gamezebo.com/walkthroughs/mob-control-strategy-guide-take-control-with-these-hints-tips-and-cheats-2/)
- [Mob Control - SilverGames](https://www.silvergames.com/en/mob-control)
- [Mob Control Analysis - MAF](https://maf.ad/en/blog/mob-control-analysis-hybrid-casual/)

---

*計画作成日: 2025-01-17*
*ステータス: 完了 (2025-01-17)*
